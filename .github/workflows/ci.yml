# 完整 CI 流程
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# 检测文件变更，决定运行哪些测试
jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/app/**'
              - 'backend/tests/**'
              - 'backend/requirements.txt'
            frontend:
              - 'miniprogram/utils/**'
              - 'miniprogram/__tests__/**'
              - 'miniprogram/package.json'

  # 后端测试
  backend:
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' }}
    runs-on: ubuntu-latest
    name: Backend Tests

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: 缓存系统依赖
        uses: actions/cache@v4
        id: cache-apt
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: ${{ runner.os }}-apt-libreoffice-ffmpeg-cairo-v2

      - name: 安装系统依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libreoffice-core libreoffice-writer libreoffice-calc libreoffice-impress ffmpeg libcairo2-dev pkg-config

      - name: 安装 Python 依赖
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: 运行后端测试
        run: |
          cd backend
          pytest --cov=app --cov-report=xml -v

      - name: 上传后端覆盖率
        uses: codecov/codecov-action@v4
        with:
          files: backend/coverage.xml
          flags: backend
          fail_ci_if_error: false

  # 前端测试
  frontend:
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    name: Frontend Tests

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: miniprogram/package-lock.json

      - name: 安装依赖
        run: |
          cd miniprogram
          npm ci || npm install

      - name: 运行前端测试
        run: |
          cd miniprogram
          npm test -- --coverage

      - name: 上传前端覆盖率
        uses: codecov/codecov-action@v4
        with:
          files: miniprogram/coverage/lcov.info
          flags: frontend
          fail_ci_if_error: false

  # 代码质量检查
  quality:
    runs-on: ubuntu-latest
    name: Code Quality

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 代码格式检查
        run: |
          pip install black flake8
          black --check --line-length=100 backend/ || echo "::warning::Black 格式检查发现问题"
          flake8 backend/ --max-line-length=100 --extend-ignore=E203,E501,W503 --exclude=__pycache__,*.pyc,.git,venv || echo "::warning::Flake8 检查发现问题"

  # 构建状态汇总
  ci-status:
    runs-on: ubuntu-latest
    needs: [changes, backend, frontend, quality]
    if: always()
    name: CI Status

    steps:
      - name: 检查 CI 状态
        run: |
          backend_result="${{ needs.backend.result }}"
          frontend_result="${{ needs.frontend.result }}"
          quality_result="${{ needs.quality.result }}"

          # 跳过的测试不算失败
          if [ "$backend_result" = "failure" ] || [ "$frontend_result" = "failure" ] || [ "$quality_result" = "failure" ]; then
            echo "❌ CI 检查失败"
            exit 1
          else
            echo "✅ 所有 CI 检查通过"
            backend_changed="${{ needs.changes.outputs.backend }}"
            frontend_changed="${{ needs.changes.outputs.frontend }}"
            if [ "$backend_changed" = "false" ]; then
              echo "⏭️ 后端测试已跳过（无相关变更）"
            fi
            if [ "$frontend_changed" = "false" ]; then
              echo "⏭️ 前端测试已跳过（无相关变更）"
            fi
          fi
